---
import Layout from "../layouts/Layout.astro";
import { createGitHubAPI } from "../lib/github.fetch";

const api = createGitHubAPI();
let allIssues = [];
let error = null;

try {
  const [openData, closedData] = await Promise.all([
    api.listIssues({ state: "open", per_page: 30 }),
    api.listIssues({ state: "closed", per_page: 20 }),
  ]);

  allIssues = [...openData, ...closedData];
} catch (e) {
  error = e.message;
}

function formatDate(dateString) {
  return new Intl.DateTimeFormat("el-GR", {
    day: "numeric",
    month: "long",
    year: "numeric",
  }).format(new Date(dateString));
}

function getContrastColor(hexcolor) {
  const r = parseInt(hexcolor.substr(0, 2), 16);
  const g = parseInt(hexcolor.substr(2, 2), 16);
  const b = parseInt(hexcolor.substr(4, 2), 16);
  const yiq = (r * 299 + g * 587 + b * 114) / 1000;
  return yiq >= 128 ? "black" : "white";
}
---

<Layout>
  <h1 class="ui header">
    <i class="bug icon"></i>
    <div class="content">
      Αναφορές
      <div class="sub header">Προβλήματα και εργασίες προς διεκπεραίωση</div>
    </div>
  </h1>
  <div class="ui divider"></div>

  {
    error && (
      <div class="ui negative message">
        <div class="header">Σφάλμα</div>
        <p>{error}</p>
      </div>
    )
  }

  <div class="ui relaxed divided list selection large">
    {
      allIssues.map((issue) => {
        const isOpen = issue.state === "open";

        return (
          <a
            href={`/issues/${issue.number}`}
            class="item"
            style={!isOpen ? "opacity: 0.75;" : ""}
          >
            <i
              class={`large middle aligned ${isOpen ? "exclamation circle" : "check circle"} icon`}
              style={`color: ${isOpen ? "#db2828" : "#21ba45"};`}
            />
            <div class="content">
              <div
                class="header"
                style="margin-bottom: 0.3em; font-size: 1.1em;"
              >
                <span
                  style={
                    !isOpen ? "text-decoration: line-through; color: #666;" : ""
                  }
                >
                  {issue.title}
                </span>
                {issue.labels.map((label) => (
                  <span
                    class="ui label tiny"
                    style={`background-color: #${label.color}; color: ${getContrastColor(label.color)}; margin-left: 0.5em;`}
                  >
                    {label.name}
                  </span>
                ))}
              </div>
              <div class="description">
                #{issue.number} {isOpen ? "άνοιξε" : "έκλεισε"} από{" "}
                <strong>{issue.user.login}</strong> •{" "}
                {formatDate(issue.created_at)}
                <span style="float: right; color: #666;">
                  <i class="comment icon" /> {issue.comments}
                </span>
              </div>
            </div>
          </a>
        );
      })
    }
  </div>

  {
    allIssues.length === 0 && !error && (
      <div class="ui placeholder segment">
        <div class="ui icon header">
          <i class="check circle outline icon" />
          Δεν υπάρχουν ζητήματα.
        </div>
      </div>
    )
  }
</Layout>
