---
import Layout from "../layouts/Layout.astro";
import { createGitHubAPI } from "../lib/github.fetch";
import { formatDateCompactCompact, truncateText } from "../lib/utils";

const api = createGitHubAPI();
let pinned = [];
let others = [];
let error = null;

try {
  const data = await api.listDiscussions();
  pinned = data.pinned || [];

  const pinnedIds = new Set(pinned.map((p) => p.number));
  others = (data.others || []).filter((d) => !pinnedIds.has(d.number));
} catch (e) {
  error = e.message;
}
---

<Layout>
  <h1 class="ui header">
    <i class="comments icon"></i>
    <div class="content">
      Συζήτηση
      <div class="sub header">Δημόσια συζήτηση, ψηφίσματα, ερωτήσεις, κλπ</div>
    </div>
  </h1>

  {
    error && (
      <div class="ui negative message">
        <i class="exclamation circle icon" />
        <div class="content">
          <div class="header">Σφάλμα!</div>
          <p>{error}</p>
        </div>
      </div>
    )
  }

  {
    pinned.length > 0 && (
      <div class="ui segment raised">
        <a class="ui ribbon label blue">
          <i class="thumbtack icon" />
          Καρφιτσωμένο
        </a>
        <div class="ui divided items">
          {pinned.map((topic) => (
            <a
              href={`/discussion/${topic.number}`}
              class="item"
              style="color: inherit; text-decoration: none;"
            >
              <div class="content">
                <h2 class="ui header" style="margin-top: 0.5rem;">
                  {topic.title}
                </h2>
                <div class="meta">
                  <span>{topic.author.login}</span>
                  <span>•</span>
                  <span>{formatDateCompact(topic.createdAt)}</span>
                </div>
                <div class="description" style="margin-top: 1rem; color: #444;">
                  {truncateText(topic.bodyText)}
                </div>
                <div class="extra" style="margin-top: 1rem;">
                  <div class="ui label">
                    <i class="comments icon" /> {topic.comments.totalCount}
                  </div>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    )
  }

  {
    others.length > 0 && (
      <div class="ui relaxed divided list selection large">
        {others.map((topic) => (
          <a href={`/discussion/${topic.number}`} class="item">
            <i
              class="large middle aligned comment outline icon"
              style="color: #999;"
            />
            <div class="content">
              <div class="header" style="margin-bottom: 0.3em;">
                {topic.title}
              </div>
              <div class="description">
                #{topic.number} άνοιξε από <strong>{topic.author.login}</strong>{" "}
                • {formatDateCompact(topic.createdAt)}
                <span style="float: right; color: #666;">
                  <i class="comment icon" /> {topic.comments.totalCount}
                </span>
              </div>
            </div>
          </a>
        ))}
      </div>
    )
  }

  {
    pinned.length === 0 && others.length === 0 && !error && (
      <div class="ui placeholder segment">
        <div class="ui icon header">
          <i class="comments outline icon" />
          Δεν βρέθηκαν συζητήσεις.
        </div>
      </div>
    )
  }
</Layout>
