---
import Layout from "../layouts/Layout.astro";

const sessionCookie = Astro.cookies.get("gh_session");
let user = null;
let role = "Επισκέπτης";
let isAdmin = false;

if (sessionCookie && sessionCookie.value) {
    try {
        user = JSON.parse(sessionCookie.value);

        const owner = import.meta.env.GITHUB_OWNER;
        if (user.login === owner) {
            role = "Διαχειριστής";
            isAdmin = true;
        } else {
            role = "Χρήστης";
        }
    } catch (e) {
        Astro.cookies.delete("gh_session", { path: "/" });
    }
}
---

<Layout>
    <h1 class="ui header">
        <i class="cog icon"></i>
        <div class="content">
            Ρυθμίσεις
            <div class="sub header">Διαχείριση λογαριασμού και προτιμήσεων</div>
        </div>
    </h1>
    <div class="ui divider"></div>

    <div class="ui segment raised">
        {
            user ? (
                <div class="ui stackable grid">
                    <div
                        class="five wide column center aligned"
                        style="background: #f9fafb; border-right: 1px solid rgba(0,0,0,0.05);"
                    >
                        <div
                            class="ui small circular image bordered"
                            style="margin-top: 1rem; background: white; padding: 5px;"
                        >
                            <img src={user.avatar_url} alt="User Avatar" />
                        </div>

                        <div style="margin-top: 1.5rem;">
                            {isAdmin ? (
                                <div class="ui label large blue">
                                    <i class="shield alternate icon" /> {role}
                                </div>
                            ) : (
                                <div class="ui label large blue">
                                    <i class="user icon" /> {role}
                                </div>
                            )}
                        </div>
                    </div>

                    <div class="eleven wide column" style="padding: 2rem;">
                        <h2 class="ui header" style="margin-top: 0;">
                            {user.name || user.login}
                            <div class="sub header">
                                Συνδεδεμένος μέσω GitHub
                            </div>
                        </h2>

                        <div class="ui divider hidden" />

                        <div class="ui relaxed list large">
                            <div class="item">
                                <i class="large github middle aligned icon" />
                                <div class="content">
                                    <div class="header">Username</div>
                                    <div class="description">{user.login}</div>
                                </div>
                            </div>
                            <div class="item">
                                <i class="large id badge middle aligned icon" />
                                <div class="content">
                                    <div class="header">User ID</div>
                                    <div class="description">{user.id}</div>
                                </div>
                            </div>
                            <div class="item">
                                <i class="large linkify middle aligned icon" />
                                <div class="content">
                                    <a
                                        href={user.html_url}
                                        target="_blank"
                                        class="ui basic label"
                                    >
                                        Προβολή Προφίλ{" "}
                                        <i
                                            class="external alternate icon"
                                            style="margin-left: 5px;"
                                        />
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="ui divider" />

                        <form action="/api/auth/logout" method="POST">
                            <button type="submit" class="ui button red basic">
                                <i class="sign out icon" /> Αποσύνδεση
                            </button>
                        </form>
                    </div>
                </div>
            ) : (
                <div
                    class="ui placeholder segment"
                    style="border: none; box-shadow: none; min-height: 300px;"
                >
                    <div class="ui icon header">
                        <i class="github icon" />
                        Σύνδεση Λογαριασμού
                    </div>
                    <p style="font-size: 1.1em; color: #666;">
                        Συνδεθείτε με το λογαριασμό σας στο GitHub για να
                        αποκτήσετε πρόσβαση σε προηγμένες λειτουργίες.
                    </p>
                    <br />
                    <a href="/api/auth/login" class="ui black huge button">
                        <i class="github icon" />
                        Σύνδεση με GitHub
                    </a>
                </div>
            )
        }
    </div>

    {
        user && (
            <div class="ui segments" style="margin-top: 3rem;">
                <div
                    class="ui segment secondary inverted"
                    style="background-color: #1b1c1d;"
                >
                    <h4 class="ui header inverted">
                        <i class="terminal icon" /> Δεδομένα Συνεδρίας{" "}
                    </h4>
                </div>
                <div
                    class="ui segment"
                    style="padding: 0; background-color: #2b2b2b; color: #a9b7c6;"
                >
                    <pre style="margin: 0; padding: 1.5em; overflow-x: auto; font-family: 'Courier New', monospace;">
                        {JSON.stringify(
                            {
                                login: user.login,
                                id: user.id,
                                role: role,
                                auth_provider: "github",
                                session_valid: true,
                            },
                            null,
                            4,
                        )}
                    </pre>
                </div>
                <div class="ui bottom attached warning message">
                    <i class="info circle icon" />
                    Αυτά τα δεδομένα είναι αποθηκευμένα στο πρόγραμμα περιήγησής
                    σας (Cookies) και χρησιμοποιούνται αποκλειστικά για την
                    ταυτοποίησή σας.
                </div>
            </div>
        )
    }
</Layout>
