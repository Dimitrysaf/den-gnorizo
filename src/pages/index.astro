---
import Layout from "../layouts/Layout.astro";
import Tools from "../components/Tools.astro";
import DocNode from "../components/DocNode.astro";
import { createGitHubAPI, resetCache } from "../lib/github.fetch";
import { parseMarkdownSafe } from "../lib/markdown";
import { handleError } from "../lib/errors";

// Check Login Status for Edit Button
const sessionCookie = Astro.cookies.get("gh_session");
const isLoggedIn = !!(sessionCookie && sessionCookie.value);

if (Astro.url.searchParams.get("refresh") === "true") {
  resetCache();
}

const api = createGitHubAPI();
let documentStructure = [];
let error = null;

try {
  const rawMeta = await api.getFileContent("metadata.json");
  const metaJson = JSON.parse(rawMeta);
  documentStructure = metaJson.structure || [];

  const nodesWithFiles: any[] = [];
  function collectNodes(nodes: any[]) {
    if (!nodes) return;
    for (const node of nodes) {
      if (node.file) nodesWithFiles.push(node);
      if (node.children) collectNodes(node.children);
    }
  }

  collectNodes(documentStructure);

  const fileLoadPromises = nodesWithFiles.map(async (node) => {
    try {
      const rawMarkdown = await api.getFileContent(node.file);
      const cleanMarkdown = rawMarkdown.replace(/^---[\s\S]+?---/, "").trim();
      node.htmlContent = await parseMarkdownSafe(cleanMarkdown);
    } catch (err) {
      console.error(`Error loading file ${node.file}:`, err);
      node.htmlContent = `<div class="ui warning message">...</div>`;
    }
  });

  await Promise.race([
    Promise.all(fileLoadPromises),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("Timeout loading files")), 30000),
    ),
  ]);
} catch (e) {
  const errorInfo = handleError(e);
  error = errorInfo.message;
}
---

<Layout>
  <div class="ui grid">
    <div class="fourteen wide column">
      <h1 class="ui header">
        <i class="home icon"></i>
        <div class="content">
          Αρχική
          <div class="sub header">Η κύρια προβολή του Συντάγματος</div>
        </div>
      </h1>
    </div>
    <div class="two wide column right aligned">
      {
        isLoggedIn && (
          <a
            href="/edit"
            class="ui icon button basic"
            title="Επεξεργασία Δομής"
          >
            <i class="pencil alternate icon" />
          </a>
        )
      }
    </div>
  </div>

  <Tools />

  {error && <div class="ui negative icon message">{error}</div>}

  {
    documentStructure.length > 0
      ? documentStructure.map((node) => <DocNode node={node} />)
      : !error && (
          <div class="ui placeholder segment">Δεν υπάρχει περιεχόμενο.</div>
        )
  }
</Layout>
