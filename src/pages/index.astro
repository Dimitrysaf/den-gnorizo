---
import Layout from "../layouts/Layout.astro";
import Tools from "../components/Tools.astro";
import DocNode from "../components/DocNode.astro";
import { createGitHubAPI, resetCache } from "../lib/github.fetch";
import { parseMarkdownSafe } from "../lib/markdown";
import { handleError } from "../lib/errors";

if (Astro.url.searchParams.get("refresh") === "true") {
  resetCache();
}

const api = createGitHubAPI();
let documentStructure = [];
let error = null;

try {
  const rawMeta = await api.getFileContent("metadata.json");
  const metaJson = JSON.parse(rawMeta);
  documentStructure = metaJson.structure || [];

  const nodesWithFiles: any[] = [];
  function collectNodes(nodes: any[]) {
    if (!nodes) return;
    for (const node of nodes) {
      if (node.file) nodesWithFiles.push(node);
      if (node.children) collectNodes(node.children);
    }
  }

  collectNodes(documentStructure);

  const fileLoadPromises = nodesWithFiles.map(async (node) => {
    try {
      const rawMarkdown = await api.getFileContent(node.file);
      const cleanMarkdown = rawMarkdown.replace(/^---[\s\S]+?---/, "").trim();
      node.htmlContent = parseMarkdownSafe(cleanMarkdown);
    } catch (err) {
      console.error(`Error loading file ${node.file}:`, err);
      node.htmlContent = `
        <div class="ui warning message">
          <i class="exclamation triangle icon"></i>
          <div class="content">
            <div class="header">Σφάλμα φόρτωσης περιεχομένου</div>
            <p>Το περιεχόμενο "${node.name}" δεν ήταν δυνατό να φορτωθεί προσωρινά.</p>
          </div>
        </div>
      `;
    }
  });

  await Promise.race([
    Promise.all(fileLoadPromises),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("Timeout loading files")), 30000),
    ),
  ]);
} catch (e) {
  console.error("Index page error:", e);
  const errorInfo = handleError(e);
  error = errorInfo.message;
}
---

<Layout>
  <h1 class="ui header">
    <i class="home icon"></i>
    <div class="content">
      Αρχική
      <div class="sub header">Η κύρια προβολή του Συντάγματος και εκδώσεων</div>
    </div>
  </h1>
  <Tools />
  {
    error && (
      <div class="ui negative icon message">
        <i class="exclamation circle icon" />
        <div class="content">
          <div class="header">Σφάλμα φόρτωσης</div>
          <p>{error}</p>
        </div>
      </div>
    )
  }

  {
    documentStructure.length > 0
      ? documentStructure.map((node) => <DocNode node={node} />)
      : !error && (
          <div class="ui placeholder segment">
            <div class="ui icon header">
              <i class="file outline icon" />
              Δεν υπάρχει περιεχόμενο διαθέσιμο.
            </div>
          </div>
        )
  }
</Layout>
