---
import { createGitHubAPI } from "../lib/github.fetch";
import { handleError } from "../lib/errors";
import { formatDateCompact, truncateText } from "../lib/utils";

let branches = [];
let latestCommit = null;
let error = null;

try {
    const github = createGitHubAPI();
    branches = await github.listBranches();

    if (branches.length > 0) {
        const commits = await github.listCommits({ per_page: 1 });
        if (commits.length > 0) {
            latestCommit = commits[0];
        }
    }
} catch (e) {
    const errorInfo = handleError(e);
    error = errorInfo.message;
    console.error("Tools.astro - Error fetching branches:", e);
}

const uniqueId = `tools-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="ui segment" data-tools-id={uniqueId}>
    <div class="ui inverted dimmer tools-loader">
        <div class="ui text loader">Φόρτωση...</div>
    </div>

    <div class="error-message ui negative icon message" style="display: none;">
        <i class="exclamation circle icon"></i>
        <div class="content">
            <div class="header">Σφάλμα!</div>
            <p class="error-text"></p>
        </div>
    </div>

    {
        error ? (
            <div class="ui error icon message">
                <i class="exclamation circle icon" />
                <div class="content">
                    <div class="header">Σφάλμα!</div>
                    <p>{error}</p>
                </div>
            </div>
        ) : (
            <div>
                <div class="tools-buttons">
                    <div class="ui labeled icon button compact dropdown branch-dropdown">
                        <i class="code branch icon" />
                        <span class="text">
                            {branches.length > 0 ? branches[0].name : "Κλάδοι"}
                        </span>
                        <div class="menu">
                            {branches.length === 0 ? (
                                <div class="item disabled">
                                    Δεν βρέθηκαν κλάδοι
                                </div>
                            ) : (
                                branches.map((branch: any, index: number) => (
                                    <div
                                        class={`item ${index === 0 ? "active selected" : ""}`}
                                        data-branch={branch.name}
                                    >
                                        {branch.name}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    <button
                        class="ui icon button compact refresh-button labeled"
                        type="button"
                        title="Ανανέωση"
                        style="text-align: left;"
                    >
                        <i class="refresh icon" />
                        <span>Ανανέωση</span>
                    </button>
                </div>

                {latestCommit && (
                    <a
                        href="/commits"
                        class="ui secondary segment latest-commit link-segment"
                        style="margin-top: 1rem; display: block; color: inherit;"
                    >
                        <div class="ui relaxed list">
                            <div class="item">
                                <i class="git icon" />
                                <div class="content">
                                    <div class="description">
                                        <strong>
                                            {latestCommit.commit.author.name}
                                        </strong>
                                        <div style="margin-top: 0.5rem;">
                                            <i class="comment icon" />{" "}
                                            {latestCommit.commit.message}
                                        </div>
                                        <div style="margin-top: 0.5rem; color: #888;">
                                            <i class="code icon" />{" "}
                                            {latestCommit.sha.substring(0, 7)}
                                            <span style="margin-left: 1rem;">
                                                <i class="clock icon" />{" "}
                                                {formatDateCompact(
                                                    latestCommit.commit.author
                                                        .date,
                                                )}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                )}
            </div>
        )
    }
</div>

<style>
    .tools-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .link-segment:hover {
        background-color: #f0f0f0 !important;
        border: 1px solid #ccc !important;
    }

    @media (max-width: 768px) {
        .tools-buttons {
            flex-direction: column;
        }

        .tools-buttons > * {
            width: 100%;
        }
    }

    .latest-commit {
        font-size: 0.9rem;
    }
</style>

<script is:inline define:vars={{ uniqueId }}>
    $(function () {
        const container = $(`[data-tools-id="${uniqueId}"]`);
        const $loader = container.find(".tools-loader");
        const $dropdown = container.find(".branch-dropdown");
        const $errorMessage = container.find(".error-message");
        const $errorText = container.find(".error-text");
        const $refreshButton = container.find(".refresh-button");
        const $latestCommit = container.find(".latest-commit");

        function setLoading(state) {
            if (state) {
                $loader.addClass("active");
            } else {
                $loader.removeClass("active");
            }
        }

        setLoading(true);
        requestAnimationFrame(() => setLoading(false));

        $dropdown.dropdown();

        $errorMessage.find(".close").on("click", function () {
            $errorMessage.hide();
        });

        function formatDateCompact(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat("el-GR", {
                year: "numeric",
                month: "long",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
            }).format(date);
        }

        $refreshButton.on("click", async function () {
            setLoading(true);
            $errorMessage.hide();

            try {
                const res = await fetch("/api/github/branches");
                const branches = await res.json();

                const $menu = $dropdown.find(".menu").empty();
                branches.forEach((b, i) => {
                    $menu.append(
                        `<div class="item ${i === 0 ? "active selected" : ""}" data-branch="${b.name}">${b.name}</div>`,
                    );
                });
                $dropdown.find(".text").text(branches[0]?.name ?? "Κλάδοι");
                $dropdown.dropdown("refresh");

                const commitsRes = await fetch(
                    "/api/github/commits?per_page=1",
                );
                const commits = await commitsRes.json();

                if (commits.length > 0) {
                    const commit = commits[0];
                    const commitHtml = `
                        <div class="ui relaxed list">
                          <div class="item">
                            <i class="git icon"></i>
                            <div class="content">
                              <div class="description">
                                <strong>${commit.commit.author.name}</strong>
                                <div style="margin-top: 0.5rem;">
                                  <i class="comment icon"></i> ${commit.commit.message}
                                </div>
                                <div style="margin-top: 0.5rem; color: #888;">
                                  <i class="code icon"></i> ${commit.sha.substring(0, 7)}
                                  <span style="margin-left: 1rem;">
                                    <i class="clock icon"></i> ${formatDateCompact(commit.commit.author.date)}
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                    `;

                    if ($latestCommit.length) {
                        $latestCommit.html(commitHtml);
                    } else {
                        container
                            .find(".tools-buttons")
                            .after(
                                `<a href="/commits" class="ui secondary segment latest-commit link-segment" style="margin-top: 1rem; display: block; color: inherit;">${commitHtml}</a>`,
                            );
                    }
                }

                const currentTabPane = container.closest(".tab-pane");
                const fullId = currentTabPane.attr("id");

                if (fullId) {
                    const parts = fullId.split("-");
                    const baseId = parts.slice(2).join("-");

                    const fetchUrl = new URL(window.location.href);
                    fetchUrl.searchParams.set("refresh", "true");

                    const pageRes = await fetch(fetchUrl.toString());
                    const pageHtml = await pageRes.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(pageHtml, "text/html");

                    const newContent = doc.querySelector("main").innerHTML;

                    const desktopId = `#tab-desktop-${baseId}`;
                    if ($(desktopId).length) {
                        $(desktopId).find("main").html(newContent);
                    }

                    const mobileId = `#tab-mobile-${baseId}`;
                    if ($(mobileId).length) {
                        $(mobileId).find("main").html(newContent);
                    }
                }
            } catch (e) {
                console.error(e);
                $errorText.text("Σφάλμα ανανέωσης");
                $errorMessage.show();
                setLoading(false);
            }
        });
    });
</script>
