---
import "fomantic-ui-css/semantic.min.css";
import Analytics from '@vercel/analytics/astro'

const menuItems = [
  { href: "/", label: "Αρχική", icon: "home", id: "home" },
  {
    href: "/discussion",
    label: "Συζήτηση",
    icon: "comments",
    id: "discussion",
  },
  { href: "/prs", label: "Προτάσεις", icon: "file alternate", id: "prs" },
  { href: "/issues", label: "Αναφορές", icon: "bug", id: "issues" },
  { href: "/settings", label: "Ρυθμίσεις", icon: "cog", id: "settings" },
  { href: "/about", label: "Σχετικά", icon: "info circle", id: "about" },
];

const currentPath = Astro.url.pathname;

const getCurrentId = () => {
  if (currentPath === "/") return "home";

  const item = menuItems.find(
    (i) =>
      i.href === currentPath ||
      (i.href !== "/" && currentPath.startsWith(i.href)),
  );
  if (item) return item.id;

  return currentPath.substring(1).replace(/\//g, "-");
};

const initialId = getCurrentId();

const isActive = (href: string) => {
  return currentPath === href || (href !== "/" && currentPath.startsWith(href));
};
---

<!doctype html>
<html lang="el">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Α΄ Συντακτική Βουλή των Πολιτών</title>
    <Analytics />
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.9.3/semantic.min.css"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.9.3/semantic.min.js"
    ></script>
    <style>
      .desktop-only {
        display: none;
      }
      .mobile-only {
        display: block;
      }

      @media (min-width: 992px) {
        .desktop-only {
          display: block;
          background-color: white;
        }
        .mobile-only {
          display: none;
        }
      }

      body.mobile-view {
        padding-top: 3.5rem;
        margin-top: 1rem;
        background-color: white;
      }

      .desktop-content-wrapper {
        max-width: 900px;
        margin: 0 auto;
        padding: 1rem;
        background-color: white;
      }

      .desktop-only .ui.pointing.menu {
        background-color: white;
      }

      #sidebar-menu .header.item {
        padding: 1.5rem 1rem !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      #sidebar-menu .header.item h2 {
        margin: 0;
        font-size: 1.5rem;
      }

      #sidebar-menu .close.icon {
        position: absolute;
        top: 1rem;
        right: 1rem;
        cursor: pointer;
        font-size: 1.5rem;
        z-index: 1;
      }

      .ui.container {
        padding: 2rem 1rem;
      }

      @media (max-width: 991px) {
        .ui.container {
          margin-top: 1rem;
        }
      }

      .tab-pane {
        display: none;
      }

      .tab-pane.initial-visible {
        display: block;
      }

      #tab-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
      }
      #tab-loader.visible {
        display: flex;
      }
    </style>
  </head>

  <body>
    <div id="tab-loader">
      <div class="ui active large text loader">Φόρτωση...</div>
    </div>

    <div
      class="ui left vertical menu flyout mobile-only"
      id="sidebar-menu"
    >
      <i class="close icon"></i>
      <div class="header item">
        <h2 class="ui header"><i class="bars icon"></i> Πλοήγηση</h2>
      </div>
      <div class="scrolling content">
        {
          menuItems.map((item) => (
            <a
              class={`item nav-link ${isActive(item.href) ? "active" : ""}`}
              href={item.href}
              data-tab-id={item.id}
            >
              <i class={`${item.icon} icon`} />
              {item.label}
            </a>
          ))
        }
      </div>
    </div>

    <div class="pusher">
      <div class="mobile-only">
        <div class="ui top fixed menu">
          <a class="item" id="mobile-menu-toggle"
            ><i class="bars icon"></i> Μενού</a
          >
          <div class="item">
            <i class="university icon"></i>Α' Συντακτική Βουλή των Πολιτών
          </div>
        </div>
      </div>

      <div class="desktop-only">
        <div class="desktop-content-wrapper">
          <h1 class="ui header">
            <i class="university icon"></i>Α' Συντακτική Βουλή των Πολιτών
          </h1>
          <div class="ui pointing menu fluid centered">
            {
              menuItems.map((menuItem) => (
                <a
                  class={`item nav-link ${isActive(menuItem.href) ? "active" : ""}`}
                  href={menuItem.href}
                  data-tab-id={menuItem.id}
                >
                  <i class={`${menuItem.icon} icon`} />
                  {menuItem.label}
                </a>
              ))
            }
          </div>
        </div>
      </div>

      <div class="full height">
        <div class="desktop-only">
          <div class="desktop-content-wrapper">
            <div class="ui segment content-container">
              <div
                id={`tab-desktop-${initialId}`}
                class="tab-pane initial-visible"
                data-loaded="true"
              >
                <main><slot /></main>
              </div>
            </div>
          </div>
        </div>

        <div class="mobile-only">
          <div class="ui container content-container">
            <div
              id={`tab-mobile-${initialId}`}
              class="tab-pane initial-visible"
              data-loaded="true"
            >
              <main><slot /></main>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script is:inline define:vars={{ initialId }}>
      document.addEventListener("DOMContentLoaded", function () {
        let currentActiveTabId = initialId;

        $(".nav-link").on("click", function (e) {
          e.preventDefault();
          const url = $(this).attr("href");
          const tabId = $(this).data("tab-id");

          currentActiveTabId = tabId;

          $(".nav-link").removeClass("active");
          $(`.nav-link[href="${url}"]`).addClass("active");

          $(".ui.flyout").flyout("hide");

          switchTab(tabId, url);
        });

        function switchTab(tabId, url) {
          const desktopTabId = `tab-desktop-${tabId}`;
          const mobileTabId = `tab-mobile-${tabId}`;

          const desktopExists = $(`#${desktopTabId}`).length > 0;

          if (desktopExists) {
            $(".content-container > .tab-pane").hide();

            $(`#${desktopTabId}`).show();
            $(`#${mobileTabId}`).show();

            window.history.pushState({ tabId: tabId }, "", url);
            $("#tab-loader").removeClass("visible");
          } else {
            fetchAndRender(tabId, url);
          }
        }

        function fetchAndRender(tabId, url) {
          if (currentActiveTabId === tabId) {
            $("#tab-loader").addClass("visible");
          }

          $.ajax({
            url: url,
            method: "GET",
            success: function (response) {
              const parser = new DOMParser();
              const doc = parser.parseFromString(response, "text/html");
              const newContent = doc.querySelector("main").innerHTML;

              const newDesktopTab = `
                        <div id="tab-desktop-${tabId}" class="tab-pane" style="display: none;" data-loaded="true">
                            <main>${newContent}</main>
                        </div>
                    `;
              const newMobileTab = `
                        <div id="tab-mobile-${tabId}" class="tab-pane" style="display: none;" data-loaded="true">
                            <main>${newContent}</main>
                        </div>
                    `;

              $(".desktop-only .content-container").append(newDesktopTab);
              $(".mobile-only .content-container").append(newMobileTab);

              if (currentActiveTabId === tabId) {
                $(".content-container > .tab-pane").hide();

                $(`#tab-desktop-${tabId}`).show();
                $(`#tab-mobile-${tabId}`).show();

                window.history.pushState({ tabId: tabId }, "", url);
                $("#tab-loader").removeClass("visible");
              } else {
                console.log(`Background loaded: ${tabId}, kept hidden.`);
              }
            },
            error: function (err) {
              if (currentActiveTabId === tabId) {
                console.error("Fetch error", err);
                alert("Καταστροφικό σφάλμα κατά τη φόρτωση της σελίδας. Δοκιμάστε ξανά αργότερα ή επικοινωνήστε με τον διαχειριστή της σελίδας. Κοιτάξτε την Κονσόλα πατώντας F12 και στεείλτε του τα σφάλματα πατώντας σε ένα κενό δεξί κλικ και Αντιγραφή Κονσόλας. Εαν είσαστε σε κινητή συσκευή, δοκιμάστε να μπείτε απο υπολογιστή ή απλώς παραλείχτε το μύνημα και δοκιμάστε ξανά αργότερα. Αυτό το μήνυμα θα εμφανίζεται μέχρι να διορθωθεί το πρόβλημα.");
                $("#tab-loader").removeClass("visible");
              }
            },
          });
        }

        window.onpopstate = function (event) {
          location.reload();
        };

        function updateMobileClass() {
          if (window.innerWidth < 992) {
            document.body.classList.add("mobile-view");
          } else {
            document.body.classList.remove("mobile-view");
          }
        }
        updateMobileClass();
        window.addEventListener("resize", updateMobileClass);

        const menuToggle = document.getElementById("mobile-menu-toggle");
        if (menuToggle) {
          menuToggle.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            $(".ui.flyout").flyout("toggle");
          });
        }

        const closeIcon = document.querySelector("#sidebar-menu .close.icon");
        if (closeIcon) {
          closeIcon.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            $(".ui.flyout").flyout("hide");
          });
        }

        $(".ui.flyout").flyout({
          context: "body",
          duration: 300,
          transition: "slide along",
          mobileTransition: "uncover",
          onVisible: function () {
            $("body").css("overflow", "hidden");
          },
          onHide: function () {
            $("body").css("overflow", "");
          },
        });

        function handleResize() {
          if (window.innerWidth >= 992) {
            $(".ui.flyout").flyout("hide");
          }
        }
        window.addEventListener("resize", handleResize);
      });
    </script>
  </body>
</html>
